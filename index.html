<!DOCTYPE html>
<html>
<head>
    <title>Control ESP32</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Enviar Mensaje a ESP32</h1>
    
    <div>
        <input type="text" id="mensaje" placeholder="Escribe cualquier mensaje" style="width: 250px; padding: 8px;">
        <button onclick="enviarMensaje()" style="padding: 8px 15px;">Enviar</button>
    </div>
    
    <div style="margin: 15px 0;">
        <button onclick="conectarMQTT()" style="padding: 8px 15px; background: #4CAF50; color: white;">Conectar MQTT</button>
        <button onclick="desconectarMQTT()" style="padding: 8px 15px; background: #f44336; color: white;">Desconectar</button>
        <span id="estado" style="margin-left: 15px; padding: 5px 10px; background: #ffeb3b;">Desconectado</span>
    </div>
    
    <div id="log" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto; margin-top: 20px; background: #f5f5f5; font-family: monospace; font-size: 14px;"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script>
        let client = null;
        let conectado = false;
        
        // CONFIGURACI√ìN ID√âNTICA A SU ESP32
        const BROKER = "broker.hivemq.com";
        const BROKER_PORT = 8884; // WebSocket para navegador
        const TOPIC = "esp32/demo/control";
        
        function conectarMQTT() {
            if (conectado) {
                agregarLog("‚úÖ Ya est√°s conectado al broker");
                return;
            }
            
            agregarLog("üîÑ Conectando a " + BROKER + "...");
            
            // Crear cliente MQTT para Web
            client = new Paho.MQTT.Client(
                BROKER,
                BROKER_PORT,
                "web_" + Math.random().toString(16).substr(2, 8)
            );
            
            client.onConnectionLost = function(response) {
                conectado = false;
                document.getElementById('estado').textContent = "Desconectado";
                document.getElementById('estado').style.background = "#ffeb3b";
                agregarLog("‚ùå Conexi√≥n perdida con el broker");
            };
            
            client.onMessageArrived = function(message) {
                agregarLog("üì® Mensaje recibido: " + message.payloadString);
            };
            
            // Conectar al broker
            client.connect({
                onSuccess: function() {
                    conectado = true;
                    document.getElementById('estado').textContent = "Conectado ‚úì";
                    document.getElementById('estado').style.background = "#4CAF50";
                    document.getElementById('estado').style.color = "white";
                    agregarLog("‚úÖ CONECTADO a: " + BROKER);
                    agregarLog("üì° Suscrito al topic: " + TOPIC);
                    agregarLog("üöÄ Listo para enviar mensajes al ESP32");
                },
                onFailure: function(error) {
                    agregarLog("‚ùå Error de conexi√≥n: " + error.errorMessage);
                    agregarLog("üí° Recarga la p√°gina e intenta nuevamente");
                },
                useSSL: true,
                timeout: 5
            });
        }
        
        function desconectarMQTT() {
            if (client && conectado) {
                client.disconnect();
                conectado = false;
                document.getElementById('estado').textContent = "Desconectado";
                document.getElementById('estado').style.background = "#ffeb3b";
                agregarLog("üîå Desconectado del broker");
            }
        }
        
        function enviarMensaje() {
            const mensaje = document.getElementById('mensaje').value.trim();
            
            if (!mensaje) {
                agregarLog("‚ö†Ô∏è Escribe un mensaje primero");
                return;
            }
            
            if (!conectado) {
                agregarLog("‚ö†Ô∏è Primero haz click en 'Conectar MQTT'");
                return;
            }
            
            // Enviar mensaje al MISMO topic que su ESP32
            const mqttMessage = new Paho.MQTT.Message(mensaje);
            mqttMessage.destinationName = TOPIC;
            
            client.send(mqttMessage);
            agregarLog("üì§ ENVIADO: '" + mensaje + "'");
            agregarLog("   ‚Ü≥ Topic: " + TOPIC);
            
            // Limpiar y enfocar la caja de texto
            document.getElementById('mensaje').value = "";
            document.getElementById('mensaje').focus();
        }
        
        function agregarLog(texto) {
            const log = document.getElementById('log');
            const tiempo = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${tiempo}] ${texto}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        // Enviar con la tecla Enter
        document.getElementById('mensaje').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                enviarMensaje();
            }
        });
        
        // Mensaje inicial
        agregarLog("üí° INSTRUCCIONES:");
        agregarLog("1. Click en [Conectar MQTT]");
        agregarLog("2. Escribe cualquier mensaje");
        agregarLog("3. Click en [Enviar] o presiona Enter");
        agregarLog("4. Tu ESP32 recibir√° el mensaje inmediatamente");
        agregarLog("");
        agregarLog("üîß CONFIGURACI√ìN ACTUAL:");
        agregarLog("Broker: " + BROKER);
        agregarLog("Topic: " + TOPIC);
        agregarLog("Puerto WebSocket: " + BROKER_PORT);
    </script>
</body>
</html>
